<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Historial - MPPOP</title>
    <!-- SOLO ESTE CSS PARA TODAS LAS VISTAS -->
    <link rel="stylesheet" href="css/comun.css">
    <link rel="stylesheet" href="css/descarga.css">
</head>

<body>
    <!-- BARRA SUPERIOR (REUTILIZABLE) -->
    <header class="barra-mppop">
        <img src="https://images.seeklogo.com/logo-png/53/1/mppop-logo-png_seeklogo-537041.png" alt="MPPOP"
            class="logo-mppop">

        <div class="botones-superiores">
            <span style="padding: 8px 15px; color: #2C3E50; font-weight: bold;">
                Usuario Actual
            </span>
            <button class="btn-superior" onclick="location.href='vis_admin.html'">
                üìä Admin
            </button>
            <button class="btn-superior" onclick="alert('Tickets activos')">
                üìã Tickets
            </button>
            <button class="btn-superior" onclick="location.href='vis_inicioSesion.html'">
                üö™ Cerrar Sesi√≥n
            </button>
        </div>
    </header>

    <!-- CONTENIDO ESPEC√çFICO DE ESTA VISTA -->
    <div class="contenedor">
        <div class="descarga-mppop">
            <button id="descargaToggle" class="descarga-toggle" aria-expanded="false" title="Descarga">
                Descarga <span id="descargaIcon" class="icon arrow">‚ñæ</span>
            </button>
            <div id="descargaMenu" class="descarga-menu" hidden>
                <select id="mesHistorial" class="select-mppop">
                    <option value="">Mes</option>
                    <option value="Enero">Enero</option>
                    <option value="Febrero">Febrero</option>
                    <option value="Marzo">Marzo</option>
                    <option value="Abril">Abril</option>
                    <option value="Mayo">Mayo</option>
                    <option value="Junio">Junio</option>
                    <option value="Julio">Julio</option>
                    <option value="Agosto">Agosto</option>
                    <option value="Septiembre">Septiembre</option>
                    <option value="Octubre">Octubre</option>
                    <option value="Noviembre">Noviembre</option>
                    <option value="Diciembre">Diciembre</option>
                </select>
                <input id="a√±oHistorial" class="select-mppop" type="number" placeholder="A√±o" min="1900" style="width:120px; padding:6px;" />
                <button id="confirmDescarga" class="btn-confirm" title="Confirmar">‚úîÔ∏è</button>
            </div>
        </div> 
        <h1 class="titulo-pagina">Gesti√≥n de Tickets</h1>

        <table class="tabla-mppop">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Asunto</th>
                    <th>Prioridad</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th>T√©cnico</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tablaTickets">
                <!-- Se llena con JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- MODAL (REUTILIZABLE) -->
    <div id="modalAsignar" class="modal-mppop">
        <div class="modal-contenido">
            <h3>Asignar Ticket</h3>
            <p>ID: <span id="ticketId"></span></p>

            <label>Prioridad:</label>
            <select id="prioridad" class="select-mppop">
                <option value="">Seleccionar</option>
                <option value="alta">Alta</option>
                <option value="media">Media</option>
                <option value="baja">Baja</option>
            </select>

            <label>T√©cnico:</label>
            <select id="tecnico" class="select-mppop">
                <option value="">Seleccionar</option>
                <option value="1">Juan P√©rez</option>
                <option value="2">Mar√≠a Gonz√°lez</option>
            </select>

            <div style="margin-top: 20px; text-align: right;">
                <button onclick="guardarAsignacion()"
                    style="background: #007BFF; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
                    Guardar
                </button>
                <button onclick="cerrarModal()"
                    style="background: #f5f5f5; padding: 10px 20px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; margin-left: 10px;">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <script>
        let tickets = [
            { id: "TCK-001", asunto: "Error en sistema", prioridad: "", fecha: "15/12/2024", estado: "Abierto", tecnico: "" },
            { id: "TCK-002", asunto: "Solicitud acceso", prioridad: "media", fecha: "14/12/2024", estado: "En proceso", tecnico: "Juan P√©rez" }
        ];

        let ticketActual = null;

        function cargarTablaTickets() {
            const tbody = document.getElementById('tablaTickets');
            if (!tbody) return;

            tbody.innerHTML = '';

            tickets.forEach(ticket => {
                const fila = tbody.insertRow();
                const prioridad = ticket.prioridad ?
                    `<span class="badge badge-${ticket.prioridad}">${ticket.prioridad}</span>` : '-';

                fila.innerHTML = `
            <td>${ticket.id}</td>
            <td>${ticket.asunto}</td>
            <td>${prioridad}</td>
            <td>${ticket.fecha}</td>
            <td>${ticket.estado}</td>
            <td>${ticket.tecnico || '-'}</td>
            <td>
                <button class="btn-accion btn-ver" onclick="verTicket('${ticket.id}')">üëÅÔ∏è</button>
            </td>
        `;
            });
        }

        function abrirModalAsignar(id) {
            ticketActual = id;
            document.getElementById('ticketId').textContent = id;
            document.getElementById('modalAsignar').style.display = 'flex';
        }

        function cerrarModal() {
            document.getElementById('modalAsignar').style.display = 'none';
            ticketActual = null;
        }

        function guardarAsignacion() {
            const prioridad = document.getElementById('prioridad').value;
            const tecnico = document.getElementById('tecnico').value;

            if (!prioridad || !tecnico) {
                alert('Selecciona prioridad y t√©cnico');
                return;
            }

            const ticket = tickets.find(t => t.id === ticketActual);
            if (ticket) {
                ticket.prioridad = prioridad;
                ticket.tecnico = tecnico === '1' ? 'Juan P√©rez' : 'Mar√≠a Gonz√°lez';
                if (ticket.estado === 'Abierto') ticket.estado = 'En proceso';
            }

            cargarTablaTickets();
            cerrarModal();
            alert('Ticket asignado');
        }

        function verTicket(id) {
            const ticket = tickets.find(t => t.id === id);
            alert(`Ticket ${id}\nAsunto: ${ticket.asunto}\nEstado: ${ticket.estado}`);
        }

        function eliminarTicket(id) {
            if (confirm('¬øEliminar ticket ' + id + '?')) {
                tickets = tickets.filter(t => t.id !== id);
                cargarTablaTickets();
            }
        }

        // Inicializar
        if (document.getElementById('tablaTickets')) {
            cargarTablaTickets();
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function (event) {
            const modal = document.getElementById('modalAsignar');
            if (event.target === modal) {
                cerrarModal();
            }
        }
    </script>

    <script>
        (function() {
            var input = document.getElementById('a√±oHistorial');
            if (input) {
                input.max = new Date().getFullYear();
                // input.value = new Date().getFullYear(); // descomenta para a√±o por defecto
            }

            var toggle = document.getElementById('descargaToggle');
            var menu = document.getElementById('descargaMenu');
            var icon = document.getElementById('descargaIcon');
            var confirm = document.getElementById('confirmDescarga');

            function closeMenu() {
                if (!menu) return;
                menu.hidden = true;
                if (toggle) toggle.setAttribute('aria-expanded', 'false');
            }

            function openMenu() {
                if (!menu) return;
                menu.hidden = false;
                if (toggle) toggle.setAttribute('aria-expanded', 'true');
            }

            if (toggle && menu) {
                toggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (menu.hidden) openMenu(); else closeMenu();
                });
            }

            document.addEventListener('click', function() {
                closeMenu();
            });

            if (menu) menu.addEventListener('click', function(e) { e.stopPropagation(); });

            function setIconState(state) {
                if (!icon) return;
                icon.className = 'icon ' + state;
                if (state === 'loading') icon.textContent = '‚ü≥';
                else if (state === 'success') icon.textContent = '‚úî';
                else icon.textContent = '‚ñæ';
            }

            if (confirm) {
                confirm.addEventListener('click', function(e) {
                    e.preventDefault();
                    closeMenu();
                    setIconState('loading');
                    // Simular carga y mostrar check durante 5s
                    setTimeout(function() {
                        setIconState('success');
                        setTimeout(function() {
                            setIconState('arrow');
                        }, 5000);
                    }, 800);
                });
            }

        })();
    </script>


</body>

</html>