<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Admin - MPPOP</title>
    <!-- SOLO ESTE CSS PARA TODAS LAS VISTAS -->
    <link rel="stylesheet" href="css/comun.css" />
  </head>

  <body>
    <!-- BARRA SUPERIOR (REUTILIZABLE) -->
    <header class="barra-mppop">
      <img
        src="https://images.seeklogo.com/logo-png/53/1/mppop-logo-png_seeklogo-537041.png"
        alt="MPPOP"
        class="logo-mppop"
      />

      <div class="botones-superiores">
        <span
          style="padding: 8px 15px; color: #2c3e50; font-weight: bold"
          id="admin"
        >
        </span>
        <button id="btnHistorial" class="btn-superior">
          üìä Historial
        </button>
        <button
          class="btn-superior"
          onclick="location.href = 'vis_inicioSesion.html'"
        >
          üö™ Cerrar Sesi√≥n
        </button>
      </div>
    </header>

    <!-- CONTENIDO ESPEC√çFICO DE ESTA VISTA -->
    <div class="contenedor">
      <h1 class="titulo-pagina">Gesti√≥n de Tickets</h1>

      <table class="tabla-mppop">
        <thead>
          <tr>
            <th>ID</th>
            <th>Asunto</th>
            <th>Prioridad</th>
            <th>Fecha</th>
            <th>Estado</th>
            <th>T√©cnico</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaTickets">
          <!-- Se llena con JavaScript -->
        </tbody>
      </table>
    </div>

    <!-- MODAL (REUTILIZABLE) -->
    <div id="modalAsignar" class="modal-mppop">
      <div class="modal-contenido">
        <h3>Asignar Ticket</h3>
        <p>ID: <span id="ticketId"></span></p>

        <label>Prioridad:</label>
        <select id="prioridad" class="select-mppop">
          <option value="">Seleccionar</option>
          <option value="alta">Alta</option>
          <option value="media">Media</option>
          <option value="baja">Baja</option>
        </select>

        <label for="tecnico">T√©cnico:</label>
        <select id="tecnico" class="select-mppop" required>
          <option value="">Seleccionar</option>
          <!-- Las opciones se llenar√°n din√°micamente -->
        </select>

        <div style="margin-top: 20px; text-align: right">
          <button
            onclick="guardarAsignacion()"
            style="
              background: #007bff;
              color: white;
              padding: 10px 20px;
              border: none;
              border-radius: 4px;
              cursor: pointer;
            "
          >
            Guardar
          </button>
          <button
            onclick="cerrarModal()"
            style="
              background: #f5f5f5;
              padding: 10px 20px;
              border: 1px solid #ddd;
              border-radius: 4px;
              cursor: pointer;
              margin-left: 10px;
            "
          >
            Cancelar
          </button>
        </div>
      </div>
    </div>

    <script>
      let ticketActual = null;

      // Cargar t√©cnicos
      async function cargarTecnicos() {
        try {
          const response = await fetch("/usuarios/tecnicos");
          const data = await response.json();

          if (data.success && data.data) {
            actualizarSelectTecnicos(data.data);
          }
        } catch (error) {
          console.error("Error al cargar t√©cnicos:", error);
        }
      }

      // Actualizar el select con t√©cnicos
      function actualizarSelectTecnicos(tecnicos) {
        const select = document.getElementById("tecnico");
        if (!select) return;

        // Limpiar opciones excepto "Seleccionar"
        while (select.options.length > 1) {
          select.remove(1);
        }

        // Agregar t√©cnicos de la BD
        tecnicos.forEach((tecnico) => {
          const option = document.createElement("option");
          option.value = tecnico.id;
          option.textContent = tecnico.nombre || tecnico.username;
          select.appendChild(option);
        });
      }

      async function cargarTablaTickets() {
        const tickets = await obtenerTickets();
        const tbody = document.getElementById("tablaTickets");
        if (!tbody) return;

        tbody.innerHTML = "";

        tickets.tickets.forEach((ticket) => {
          const fila = tbody.insertRow();
          const prioridad = ticket.prioridad
            ? `<span class="badge badge-${ticket.prioridad}">${ticket.prioridad}</span>`
            : "-";

          fila.innerHTML = `
            <td>${ticket.id}</td>
            <td class="celda-asunto">${ticket.asunto}</td>
            <td>${prioridad}</td>
            <td>${ticket.fecha}</td>
            <td>${ticket.estado}</td>
            <td>${ticket.tecnico || "-"}</td>
            <td>
                <button class="btn-accion btn-ver" onclick="verDetalles('${
                  ticket.id
                }')">üëÅÔ∏è</button>
                <button class="btn-accion btn-editar" onclick="abrirModalAsignar('${
                  ticket.id
                }')">‚úèÔ∏è</button>
                <button class="btn-accion btn-eliminar" onclick="eliminarTicket('${
                  ticket.id
                }')">üóëÔ∏è</button>
            </td>
        `;
        });
      }

      function abrirModalAsignar(id) {
        ticketActual = id;
        document.getElementById("ticketId").textContent = id;

        // Cargar t√©cnicos al abrir el modal (por si hay nuevos)
        cargarTecnicos();

        document.getElementById("modalAsignar").style.display = "flex";
      }

      function cerrarModal() {
        document.getElementById("modalAsignar").style.display = "none";
        ticketActual = null;
      }

      async function guardarAsignacion() {
        const prioridad = document.getElementById("prioridad").value;
        const tecnicoSelect = document.getElementById("tecnico");
        const tecnicoId = tecnicoSelect.value;
        const tecnicoNombre =
          tecnicoSelect.options[tecnicoSelect.selectedIndex].text;

        if (!prioridad || !tecnicoId) {
          alert("Selecciona prioridad y t√©cnico");
          return;
        }
        const res = await fetch("/tickets/asignarTicket", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            prioridad,
            ticket_id: Number(ticketActual),
            tecnico_codigo: tecnicoId,
          }),
        });

        const resp = await res.json();
        if (resp.success) {
          alert("Ticket asignado");
        } else {
          alert(resp.message);
        }

        cerrarModal();
        cargarTablaTickets();
      }

      async function verDetalles(ticketId) {
        try {
          const response = await fetch(`/tickets/${ticketId}`);
          const resultado = await response.json();

          if (resultado.success) {
            const ticket = resultado.ticket;
            // Muestra todos los datos que recibas
            let mensaje = `üìã Ticket: ${ticket.id}\n`;
            mensaje += `üìù Asunto: ${ticket.asunto}\n`;

            // Solo si existen estos campos
            if (ticket.nombre_completo)
              mensaje += `üë§ Solicitante: ${ticket.nombre_completo}\n`;
            if (ticket.departamento)
              mensaje += `üè¢ Departamento: ${ticket.departamento}\n`;

            mensaje += `‚ö° Prioridad: ${ticket.prioridad}\n`;
            mensaje += `üìÖ Fecha: ${ticket.fecha}\n`;
            mensaje += `üîÑ Estado: ${ticket.estado}\n`;
            if (ticket.tecnico) mensaje += `üîß T√©cnico: ${ticket.tecnico}\n`;
            if (ticket.descripcion)
              mensaje += `üìÑ Descripci√≥n: ${ticket.descripcion}`;

            alert(mensaje);
          } else {
            alert("Error: " + resultado.message);
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }

      async function eliminarTicket(id) {
        if (!confirm("¬øEliminar ticket " + id + "?")) return;
        try {
          const res = await fetch('/tickets/eliminarTicket', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ticket_id: Number(id) })
          });

          const resp = await res.json();
          if (resp.success) {
            alert('Ticket eliminado');
            cargarTablaTickets();
          } else {
            alert('Error: ' + (resp.message || 'No se pudo eliminar'));
          }
        } catch (error) {
          console.error('Error al eliminar ticket:', error);
          alert('Error al eliminar ticket');
        }
      }

      async function obtenerTickets() {
        const res = await fetch("/tickets/obtenerTicketsAdmin", {
          method: "GET",
          headers: { "Content-Type": "application/json" },
        });

        return res.json();
      }


      async function obtenerUsuario(username) {
        const res = await fetch("/usuarios/autenticar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username }),
        });

        const result = await res.json();
        const { usuario } = result;
        return usuario;
      }

      const urlParams = new URLSearchParams(window.location.search);
      const username = urlParams.get('username');
      let usuarioActual;

      async function cargarDatosPantalla() {
        usuarioActual = await obtenerUsuario(username);
        const nombreElemento = document.getElementById("admin");
        if (nombreElemento) {
          nombreElemento.textContent = `Admin: ${usuarioActual?.nombre || 'Admin'}`;
        }
        // Configurar bot√≥n Historial para conservar username en la query
        const btnHist = document.getElementById('btnHistorial');
        if (btnHist) {
          if (username) btnHist.addEventListener('click', () => location.href = `vis_historial.html?username=${encodeURIComponent(username)}`);
          else btnHist.addEventListener('click', () => location.href = 'vis_historial.html');
        }
        cargarTecnicos();
        cargarTablaTickets();
      }

      // Inicializar
      document.addEventListener("DOMContentLoaded", cargarDatosPantalla);

      // Cerrar modal al hacer clic fuera
      window.onclick = function (event) {
        const modal = document.getElementById("modalAsignar");
        if (event.target === modal) {
          cerrarModal();
        }
      };
    </script>
  </body>
</html>
