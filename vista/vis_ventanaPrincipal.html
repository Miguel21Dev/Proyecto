<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MPPOP - Inicio</title>
    <link rel="stylesheet" href="css/comun.css">
</head>
<body>
    <!-- BARRA SUPERIOR -->
    <header class="barra-mppop">
        <img src="https://images.seeklogo.com/logo-png/53/1/mppop-logo-png_seeklogo-537041.png" 
             alt="MPPOP" class="logo-mppop">
        
        <div class="botones-superiores">
            <button class="btn-superior" onclick="location.href='vis_registro.html'">
                Registrarse
            </button>
            <button class="btn-superior" onclick="location.href='vis_inicioSesion.html'">
                Iniciar Sesión
            </button>
        </div>
    </header>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="contenedor">
        <h1 class="titulo-pagina">Crear solicitud de soporte</h1>
        
        <div style="background: white; padding: 20px; border-radius: 8px; max-width: 500px; margin: 0 auto;">
            <form id="form-ticket">
                <!-- Nombre -->
                <label style="display: block; margin: 10px 0 5px;">Nombre completo *</label>
                <input type="text" name="nombre" id="nombre" class="input-mppop" required>

                <!-- Departamento -->
                <label style="display: block; margin: 10px 0 5px;">Departamento *</label>
                <select name="departamento" id="departamento" class="select-mppop" required>
                    <option value="">Seleccionar</option>
                    <option>Atención al ciudadano</option>
                    <option>Auditoria Interna</option>
                    <option>Consultoria Jurídica</option>
                    <option>Dir. General de Despacho</option>
                    <option>Estrategia de Seguimiento y Evaluación de Políticas Públicas</option>
                    <option>Gestión Comunicacional</option>
                    <option>Gestión Humana</option>
                    <option>Planificación y Presupuesto</option>
                    <option>Recursos Humanos</option>
                    <option>Tecnología de la Información y Comunicación</option>
                    <option>Vic. de Normativa y Políticas de Gestión</option>
                    <option>Vic. de Planificación de Obras públicas</option>
                    <option>Vic. de Fiscalización de Obras públicas</option>
                    <option>Otro (Indicar piso/oficina en el "Asunto")</option>
                </select>

                <!-- Asunto -->
                <label style="display: block; margin: 10px 0 5px;">Asunto *</label>
                <textarea name="asunto" id="asunto" class="input-mppopA" maxlength="200" required></textarea>
                <div id="asunto-error" style="color:#d32f2f; font-size:13px; margin-top:6px; display:none;"></div>
                <div id="asunto-count" style="font-size:12px; color:#666; text-align:right;">0/200</div>

                <!-- Campos obligatorios -->
                <label style="color: rgb(202, 0, 0); padding: 10px; width: 100%; margin-top: 20px;font-size: 12px;">(*) CAMPOS OBLIGATORIOS</label>

                <!-- Botón -->
                <button type="submit"
                        style="background: #007BFF; color: white; padding: 10px; border: none; border-radius: 4px; width: 100%; margin-top: 20px; cursor: pointer;font-size: 16px;">
                    Enviar solicitud
                </button>
            </form>
        </div>
    </div>

    <script>
        document.getElementById('form-ticket').addEventListener('submit', async function (e) {
            e.preventDefault();

            const nombre = document.getElementById('nombre').value.trim();
            const departamento = document.getElementById('departamento').value;
            const asuntoEl = document.getElementById('asunto');
            const asunto = asuntoEl.value.trim();
            const asuntoError = document.getElementById('asunto-error');
            const asuntoCount = document.getElementById('asunto-count');

            asuntoCount.textContent = `${asunto.length}/200`;

            // Validación: nombre sólo letras y espacios; asunto permite algunos signos básicos
            const nameOnlyRegex = /^[\p{L}\s]+$/u; // sólo letras (Unicode) y espacios
            const safeTextRegex = /^[\p{L}\p{N}\s.,\-()]+$/u;

            if (asunto.length > 200) {
                asuntoError.textContent = 'El asunto supera el límite de 200 caracteres.';
                asuntoError.style.display = 'block';
                asuntoEl.focus();
                return;
            } else {
                asuntoError.style.display = 'none';
            }

            if (!nombre) {
                alert('El nombre es obligatorio.');
                return;
            }
            if (!nameOnlyRegex.test(nombre)) {
                alert('El nombre sólo debe contener letras y espacios.');
                return;
            }

            if (!departamento) {
                alert('Selecciona un departamento.');
                return;
            }

            if (!asunto) {
                alert('El asunto es obligatorio.');
                return;
            }
            if (!safeTextRegex.test(asunto)) {
                alert('El asunto contiene caracteres no permitidos. Evita símbolos especiales.');
                return;
            }

            try {
                const resp = await fetch('/tickets/crearTicket', {
                    method: 'POST',
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({nombre, departamento, asunto})
                });

                const result = await resp.json();

                if (!resp.ok) {
                    alert(result.message || 'Error al crear ticket');
                    return;
                }

                if (result.success) {
                    alert(`Ticket creado exitosamente: ${result.ticket.id}`);
                    this.reset();
                } else {
                    alert(`Error:  ${result.message || 'No se pudo crear el ticket'}`);
                }

            } catch (err) {
                console.error(err);
                alert('Error de red al conectar con el servidor.');
            }
        });

        // Mostrar contador y validar en tiempo real
        const asuntoInput = document.getElementById('asunto');
        const asuntoCountEl = document.getElementById('asunto-count');
        const asuntoErrorEl = document.getElementById('asunto-error');
        if (asuntoInput) {
            asuntoCountEl.textContent = `${asuntoInput.value.length}/200`;
            asuntoInput.addEventListener('input', () => {
                const len = asuntoInput.value.length;
                asuntoCountEl.textContent = `${len}/200`;
                if (len > 200) {
                    asuntoErrorEl.textContent = 'El asunto supera el límite de 200 caracteres.';
                    asuntoErrorEl.style.display = 'block';
                } else {
                    asuntoErrorEl.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>