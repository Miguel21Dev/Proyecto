<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>TÃ©cnico - MPPOP</title>
    <link rel="stylesheet" href="css/comun.css">
</head>

<body>
    <header class="barra-mppop">
        <img src="https://images.seeklogo.com/logo-png/53/1/mppop-logo-png_seeklogo-537041.png" alt="MPPOP"
            class="logo-mppop">
        <div class="botones-superiores">
            <span style="padding: 8px 15px; color: #2C3E50; font-weight: bold;">
                TÃ©cnico: Juan PÃ©rez
            </span>
            <button class="btn-superior" onclick="window.location.href='vis_inicioSesion.html'">
                ğŸšª Cerrar SesiÃ³n
            </button>
        </div>
    </header>

    <div class="contenedor">
        <h1 class="titulo-pagina">Mis Tickets Asignados</h1>

        <table class="tabla-mppop">
            <thead>
                <tr>
                    <th>ID Ticket</th>
                    <th>Asunto</th>
                    <th>Prioridad</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tablaTicketsTecnico">
                <!-- JavaScript llena esto -->
            </tbody>
        </table>
    </div>

    <script>
        // tecnico.js - VersiÃ³n con PHP/PostgreSQL
        // TICKETS ASIGNADOS AL TÃ‰CNICO ACTUAL

        let ticketsTecnico = [];
        const tecnicoActual = "Juan PÃ©rez"; // Esto deberÃ­a venir de la sesiÃ³n

        // Cargar tickets asignados al tÃ©cnico
        async function cargarTicketsTecnico() {
            const tbody = document.getElementById('tablaTicketsTecnico');
            if (!tbody) return;

            try {
                const formData = new FormData();
                formData.append('accion', 'obtener_tecnico');
                formData.append('tecnico', tecnicoActual);

                const response = await fetch('tickets_api.php', {
                    method: 'POST',
                    body: formData
                });

                const resultado = await response.json();

                if (resultado.success) {
                    ticketsTecnico = resultado.tickets;
                    actualizarTablaTecnico();
                } else {
                    console.error('Error al cargar tickets:', resultado.message);
                    // Mostrar datos de ejemplo si hay error
                    mostrarDatosEjemploTecnico();
                }
            } catch (error) {
                console.error('Error de conexiÃ³n:', error);
                mostrarDatosEjemploTecnico();
            }
        }

        function actualizarTablaTecnico() {
            const tbody = document.getElementById('tablaTicketsTecnico');
            if (!tbody) return;

            tbody.innerHTML = '';

            ticketsTecnico.forEach(ticket => {
                const fila = tbody.insertRow();

                // BotÃ³n de estado (EDITABLE)
                const selectEstado = `
            <select class="select-mppop select-estado" 
                    onchange="cambiarEstado('${ticket.id}', this.value)"
                    style="width: 120px; padding: 5px;">
                <option value="Abierto" ${ticket.estado === 'Abierto' ? 'selected' : ''}>Abierto</option>
                <option value="Activo" ${ticket.estado === 'Activo' ? 'selected' : ''}>Activo</option>
                <option value="En proceso" ${ticket.estado === 'En proceso' ? 'selected' : ''}>En proceso</option>
                <option value="Finalizado" ${ticket.estado === 'Finalizado' ? 'selected' : ''}>Finalizado</option>
            </select>
        `;

                fila.innerHTML = `
            <td>${ticket.id}</td>
            <td>${ticket.asunto}</td>
            <td><span class="badge badge-${ticket.prioridad}">${ticket.prioridad}</span></td>
            <td>${ticket.fecha}</td>
            <td>${selectEstado}</td>
            <td>
                <button class="btn-accion btn-ver" onclick="verDetalles('${ticket.id}')">ğŸ‘ï¸</button>
                <button class="btn-accion" onclick="tomarTicket('${ticket.id}')" 
                        style="background: #e0f7fa; color: #0097a7;"
                        ${ticket.estado === 'En proceso' ? 'disabled' : ''}>
                    ${ticket.estado === 'En proceso' ? 'âœ… En proceso' : 'âœ… Tomar'}
                </button>
            </td>
        `;
            });
        }

        function mostrarDatosEjemploTecnico() {
            const tbody = document.getElementById('tablaTicketsTecnico');
            if (!tbody) return;

            tbody.innerHTML = '';

            const datosEjemplo = [
                { id: "TCK-001", asunto: "Error en sistema", prioridad: "alta", fecha: "15/12/2024", estado: "Activo", tecnico: "Juan PÃ©rez" },
                { id: "TCK-002", asunto: "Solicitud acceso", prioridad: "media", fecha: "14/12/2024", estado: "En proceso", tecnico: "Juan PÃ©rez" }
            ];

            datosEjemplo.forEach(ticket => {
                const fila = tbody.insertRow();

                const selectEstado = `
            <select class="select-mppop select-estado" 
                    onchange="cambiarEstado('${ticket.id}', this.value)"
                    style="width: 120px; padding: 5px;">
                <option value="Abierto" ${ticket.estado === 'Abierto' ? 'selected' : ''}>Abierto</option>
                <option value="Activo" ${ticket.estado === 'Activo' ? 'selected' : ''}>Activo</option>
                <option value="En proceso" ${ticket.estado === 'En proceso' ? 'selected' : ''}>En proceso</option>
                <option value="Finalizado" ${ticket.estado === 'Finalizado' ? 'selected' : ''}>Finalizado</option>
            </select>
        `;

                fila.innerHTML = `
            <td>${ticket.id}</td>
            <td>${ticket.asunto}</td>
            <td><span class="badge badge-${ticket.prioridad}">${ticket.prioridad}</span></td>
            <td>${ticket.fecha}</td>
            <td>${selectEstado}</td>
            <td>
                <button class="btn-accion btn-ver" onclick="verDetalles('${ticket.id}')">ğŸ‘ï¸</button>
                <button class="btn-accion" onclick="tomarTicket('${ticket.id}')" 
                        style="background: #e0f7fa; color: #0097a7;"
                        ${ticket.estado === 'En proceso' ? 'disabled' : ''}>
                    ${ticket.estado === 'En proceso' ? 'âœ… En proceso' : 'âœ… Tomar'}
                </button>
            </td>
        `;
            });

            ticketsTecnico = datosEjemplo;
        }

        async function cambiarEstado(ticketId, nuevoEstado) {
            try {
                const formData = new FormData();
                formData.append('accion', 'cambiar_estado');
                formData.append('ticket_id', ticketId);
                formData.append('estado', nuevoEstado);
                formData.append('tecnico', tecnicoActual);

                const response = await fetch('tickets_api.php', {
                    method: 'POST',
                    body: formData
                });

                const resultado = await response.json();

                if (resultado.success) {
                    console.log(`Ticket ${ticketId} cambiado a: ${nuevoEstado}`);

                    // Actualizar el ticket localmente
                    const ticket = ticketsTecnico.find(t => t.id === ticketId);
                    if (ticket) {
                        ticket.estado = nuevoEstado;
                    }

                    // Recargar la tabla si es necesario
                    if (nuevoEstado === 'Finalizado') {
                        await cargarTicketsTecnico();
                    }
                } else {
                    console.error('Error:', resultado.message);
                    alert('Error al cambiar estado: ' + resultado.message);

                    // Revertir el cambio en el select
                    const select = document.querySelector(`select[onchange*="${ticketId}"]`);
                    if (select) {
                        const ticket = ticketsTecnico.find(t => t.id === ticketId);
                        if (ticket) {
                            select.value = ticket.estado;
                        }
                    }
                }
            } catch (error) {
                console.error('Error de conexiÃ³n:', error);

                // Actualizar localmente si falla la conexiÃ³n
                const ticket = ticketsTecnico.find(t => t.id === ticketId);
                if (ticket) {
                    ticket.estado = nuevoEstado;
                    console.log(`Ticket ${ticketId} cambiado localmente a: ${nuevoEstado}`);
                }
            }
        }

        async function tomarTicket(ticketId) {
            if (confirm('Â¿Tomar este ticket?')) {
                try {
                    const formData = new FormData();
                    formData.append('accion', 'tomar_ticket');
                    formData.append('ticket_id', ticketId);
                    formData.append('tecnico', tecnicoActual);

                    const response = await fetch('tickets_api.php', {
                        method: 'POST',
                        body: formData
                    });

                    const resultado = await response.json();

                    if (resultado.success) {
                        alert(`Ticket ${ticketId} tomado`);
                        await cargarTicketsTecnico();
                    } else {
                        alert('Error: ' + resultado.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    // Actualizar localmente
                    cambiarEstado(ticketId, 'En proceso');
                    alert(`Ticket ${ticketId} tomado (sin conexiÃ³n al servidor)`);
                }
            }
        }

        async function verDetalles(ticketId) {
            try {
                const formData = new FormData();
                formData.append('accion', 'obtener');
                formData.append('ticket_id', ticketId);

                const response = await fetch('tickets_api.php', {
                    method: 'POST',
                    body: formData
                });

                const resultado = await response.json();

                if (resultado.success) {
                    const ticket = resultado.ticket;
                    alert(`ğŸ“‹ Ticket: ${ticket.id}\nğŸ“ Asunto: ${ticket.asunto}\nğŸ‘¤ Solicitante: ${ticket.nombre_completo}\nğŸ¢ Departamento: ${ticket.departamento}\nâš¡ Prioridad: ${ticket.prioridad}\nğŸ“… Fecha: ${ticket.fecha}\nğŸ”„ Estado: ${ticket.estado}\nğŸ”§ TÃ©cnico: ${ticket.tecnico || 'No asignado'}`);
                } else {
                    // Buscar en datos locales
                    const ticket = ticketsTecnico.find(t => t.id === ticketId);
                    if (ticket) {
                        alert(`ğŸ“‹ Ticket: ${ticket.id}\nğŸ“ Asunto: ${ticket.asunto}\nâš¡ Prioridad: ${ticket.prioridad}\nğŸ“… Fecha: ${ticket.fecha}\nğŸ”„ Estado: ${ticket.estado}`);
                    } else {
                        alert('Error: ' + resultado.message);
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                // Buscar en datos locales
                const ticket = ticketsTecnico.find(t => t.id === ticketId);
                if (ticket) {
                    alert(`ğŸ“‹ Ticket: ${ticket.id}\nğŸ“ Asunto: ${ticket.asunto}\nâš¡ Prioridad: ${ticket.prioridad}\nğŸ“… Fecha: ${ticket.fecha}\nğŸ”„ Estado: ${ticket.estado}`);
                }
            }
        }

        // Inicializar
        if (document.getElementById('tablaTicketsTecnico')) {
            cargarTicketsTecnico();
        }
    </script>
</body>

</html>