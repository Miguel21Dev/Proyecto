<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>T√©cnico - MPPOP</title>
    <link rel="stylesheet" href="css/comun.css">
</head>

<body>
    <header class="barra-mppop">  
        <img src="https://images.seeklogo.com/logo-png/53/1/mppop-logo-png_seeklogo-537041.png" alt="MPPOP"
            class="logo-mppop">
        <div class="botones-superiores">
            <span style="padding: 8px 15px; color: #2C3E50; font-weight: bold;" id="nombreTecnico">
            </span>
            <button class="btn-superior" onclick="location.href='vis_inicioSesion.html'">
                üö™ Cerrar Sesi√≥n
            </button>
        </div>
    </header>

    <div class="contenedor">
        <h1 class="titulo-pagina">Mis Tickets Asignados</h1>

        <table class="tabla-mppop">
            <thead>
                <tr>
                    <th>ID Ticket</th>
                    <th>Asunto</th>
                    <th>Prioridad</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tablaTicketsTecnico">
                <!-- JavaScript llena esto -->
            </tbody>
        </table>
    </div>

<script>
    // Obtener username de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const username = urlParams.get('username');
    
    if (!username) {
        alert('No se encontr√≥ informaci√≥n de usuario. Redirigiendo...');
        window.location.href = 'vis_inicioSesion.html';
    }
    
    let ticketsTecnico = [];
    let usuarioActual;


   
    document.addEventListener('DOMContentLoaded', cargarDatosPantalla);

    async function cargarDatosPantalla(){
        usuarioActual = await obtenerUsuario(username)
           const nombreElemento = document.getElementById('nombreTecnico');
        if (nombreElemento) {
            nombreElemento.textContent = `T√©cnico: ${usuarioActual.nombre}`;
        }
        cargarTicketsTecnico();
    }

     async function obtenerUsuario(username) {
        const res = await fetch("/usuarios/autenticar", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },                        
                    body: JSON.stringify({username}),
                });

        const result = await res.json()
        const { usuario } = result
        return usuario
    }

    async function cargarTicketsTecnico() {
        const tbody = document.getElementById('tablaTicketsTecnico');
        if (!tbody) return;

        try {
            const response = await fetch(`/tickets/tecnico/${usuarioActual.id}`);
            const resultado = await response.json();

            if (resultado.success) {
                ticketsTecnico = resultado.tickets || resultado.data || [];
                actualizarTablaTecnico();
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function actualizarTablaTecnico() {
        const tbody = document.getElementById('tablaTicketsTecnico');
        if (!tbody) return;

        tbody.innerHTML = '';

        if (ticketsTecnico.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 20px;">
                        No hay tickets asignados
                    </td>
                </tr>
            `;
            return;
        }

        ticketsTecnico.forEach(ticket => {
            const fila = tbody.insertRow();
            const ticketId = ticket.id || ticket.ticket_id;

            const selectEstado = `
                <select class="select-mppop select-estado" 
                        onchange="cambiarEstado('${ticketId}', this.value)">
                    <option value="activo" ${ticket.estado === 'activo' ? 'selected' : ''}>Activo</option>
                    <option value="en proceso" ${ticket.estado === 'en proceso' ? 'selected' : ''}>En proceso</option>
                    <option value="finalizado" ${ticket.estado === 'finalizado' ? 'selected' : ''}>Finalizado</option>
                </select>
            `;

            fila.innerHTML = `
                <td>${ticketId}</td>
                <td class="celda-asunto">${ticket.asunto}</td>
                <td><span class="badge badge-${ticket.prioridad}">${ticket.prioridad}</span></td>
                <td>${ticket.fecha}</td>
                <td>${selectEstado}</td>
                <td>
                    <button class="btn-accion btn-ver" onclick="verDetalles('${ticketId}')">üëÅÔ∏è</button>
                </td>
            `;
        });
    }

    async function cambiarEstado(ticketId, nuevoEstado) {
        try {
            const response = await fetch(`/tickets/${ticketId}/estado`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ estado: nuevoEstado, userId: usuarioActual.id })
            });

            const resultado = await response.json();

            if (resultado.success) {
                const ticket = ticketsTecnico.find(t => t.id === ticketId || t.ticket_id === ticketId);
                if (ticket) ticket.estado = nuevoEstado;
                if (nuevoEstado === 'Finalizado') cargarTicketsTecnico();
            } else {
                alert('Error: ' + resultado.message);
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }


    async function verDetalles(ticketId) {
    try {
        const response = await fetch(`/tickets/${ticketId}`);
        const resultado = await response.json();

        if (resultado.success) {
            const ticket = resultado.ticket;
            // Muestra todos los datos que recibas
            let mensaje = `üìã Ticket: ${ticket.id}\n`;
            mensaje += `üìù Asunto: ${ticket.asunto}\n`;
            
            // Solo si existen estos campos
            if (ticket.nombre_completo) mensaje += `üë§ Solicitante: ${ticket.nombre_completo}\n`;
            if (ticket.departamento) mensaje += `üè¢ Departamento: ${ticket.departamento}\n`;
            
            mensaje += `‚ö° Prioridad: ${ticket.prioridad}\n`;
            mensaje += `üìÖ Fecha: ${ticket.fecha}\n`;
            mensaje += `üîÑ Estado: ${ticket.estado}\n`;
            if (ticket.tecnico) mensaje += `üîß T√©cnico: ${ticket.tecnico}\n`;
            if (ticket.descripcion) mensaje += `üìÑ Descripci√≥n: ${ticket.descripcion}`;
            
            alert(mensaje);
        } else {
            alert('Error: ' + resultado.message);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}
</script>
</body>

</html>